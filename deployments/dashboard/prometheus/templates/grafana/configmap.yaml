apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-datasources
  namespace: {{ $.Release.Namespace }}
data:
  prometheus.yaml: |-
    {
        "apiVersion": 1,
        "datasources": [
            {
               "access":"proxy",
                "editable": true,
                "name": "prometheus",
                "orgId": 1,
                "type": "prometheus",
                "url": "http://prometheus-service.{{ $.Release.Namespace }}.svc:9090",
                "version": 1
            }
        ]
    }

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard-provider
  namespace: {{ $.Release.Namespace }}
data:
  dashboard.yaml: |-
    apiVersion: 1
    providers:
      - name: 'ioi-default'
        # <int> Org id. Default to 1
        orgId: 1
        # <string> name of the dashboard folder.
        folder: ''
        # <string> folder UID. will be automatically generated if not specified
        folderUid: ''
        # <string> provider type. Default to 'file'
        type: file
        # <bool> disable dashboard deletion
        disableDeletion: false
        # <bool> enable dashboard editing
        editable: true
        # <int> how often Grafana will scan for changed dashboards
        updateIntervalSeconds: 10
        # <bool> allow updating provisioned dashboards from the UI
        allowUiUpdates: false
        options:
          # <string, required> path to dashboard files on disk. Required when using the 'file' type
          path: /etc/grafana/dashboards-files   

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboard
  namespace: {{ $.Release.Namespace }}
data:
  ioi.json: |-
    {{`{"annotations":{"list":[{"builtIn":1,"datasource":{"type":"datasource","uid":"grafana"},"enable":true,"hide":true,"iconColor":"rgba(0, 211, 255, 1)","name":"Annotations & Alerts","target":{"limit":100,"matchAny":false,"tags":[],"type":"dashboard"},"type":"dashboard"}]},"editable":true,"fiscalYearStartMonth":0,"graphTooltip":0,"id":4,"links":[],"liveNow":false,"panels":[{"collapsed":false,"gridPos":{"h":1,"w":24,"x":0,"y":0},"id":30,"panels":[],"title":"Scheduler View: Network","type":"row"},{"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"description":"","fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"left","barAlignment":0,"drawStyle":"line","fillOpacity":0,"gradientMode":"none","hideFrom":{"legend":false,"tooltip":false,"viz":false},"lineInterpolation":"stepBefore","lineStyle":{"fill":"solid"},"lineWidth":1,"pointSize":5,"scaleDistribution":{"type":"linear"},"showPoints":"auto","spanNulls":true,"stacking":{"group":"A","mode":"none"},"thresholdsStyle":{"mode":"off"}},"decimals":2,"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green"},{"color":"red","value":80}]},"unit":"Mbits"},"overrides":[]},"gridPos":{"h":9,"w":12,"x":0,"y":1},"id":31,"options":{"legend":{"calcs":[],"displayMode":"list","placement":"right","showLegend":true},"tooltip":{"mode":"single","sort":"none"}},"targets":[{"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"editorMode":"code","expr":"sum by (sr,node,nic) (net_total_bw{node=\"$node\",nic=\"$nic\",sr=\"$sr\",wtype=\"GA\"} )","hide":false,"interval":"1","legendFormat":"GA/BT Total:{{node}}:{{sr}}","range":true,"refId":"A"},{"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"editorMode":"code","expr":"sum by (sr,node,nic) (net_request_sum_bw{node=\"$node\",nic=\"$nic\",sr=\"$sr\",wtype=\"GA\"} )","hide":false,"interval":"1","legendFormat":"GA Total Req:{{node}}:{{sr}}","range":true,"refId":"B"},{"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"editorMode":"code","expr":"sum by (sr,node,nic) (net_request_sum_bw{node=\"$node\",nic=\"$nic\",sr=\"$sr\",wtype=\"BT\"} )","hide":false,"interval":"1","legendFormat":"BT Total Req:{{node}}:{{sr}}","range":true,"refId":"C"},{"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"editorMode":"code","expr":"sum by (sr,node,nic) (net_total_bw{node=\"$node\",nic=\"$nic\",sr=\"$sr\",wtype=\"BE\"} )","hide":false,"interval":"1","legendFormat":"BE Total:{{node}}:{{sr}}","range":true,"refId":"D"}],"title":"Node-level Bandwidth","type":"timeseries"},{"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"description":"","fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"left","barAlignment":0,"drawStyle":"line","fillOpacity":0,"gradientMode":"none","hideFrom":{"legend":false,"tooltip":false,"viz":false},"lineInterpolation":"smooth","lineStyle":{"fill":"solid"},"lineWidth":1,"pointSize":5,"scaleDistribution":{"type":"linear"},"showPoints":"auto","spanNulls":false,"stacking":{"group":"A","mode":"none"},"thresholdsStyle":{"mode":"off"}},"decimals":2,"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green"},{"color":"red","value":80}]},"unit":"Mbits"},"overrides":[]},"gridPos":{"h":9,"w":12,"x":12,"y":1},"id":46,"options":{"legend":{"calcs":[],"displayMode":"list","placement":"right","showLegend":true},"tooltip":{"mode":"single","sort":"none"}},"targets":[{"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"editorMode":"code","expr":"sum by (pod,node,sr,wtype)(net_pods_limit_bw{node=\"$node\",sr=\"$sr\",pod=\"$pod\"} )","hide":false,"interval":"1","legendFormat":"lim:{{pod}}:{{wtype}}:{{sr}}","range":true,"refId":"C"},{"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"editorMode":"code","expr":"sum by (pod,sr,wtype,node)(net_pods_request_bw{node=\"$node\",sr=\"$sr\",pod=\"$pod\"} )","hide":false,"interval":"1","legendFormat":"req:{{pod}}:{{wtype}}:{{sr}}","range":true,"refId":"A"},{"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"editorMode":"code","expr":"sum by (pod,sr,wtype,node)(net_pods_real_bw{node=\"$node\",sr=\"$sr\",pod=\"$pod\"} )","hide":false,"interval":"1","legendFormat":"real:{{pod}}:{{wtype}}:{{sr}}","range":true,"refId":"B"}],"title":"Pod-level Bandwidth","type":"timeseries"},{"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"mappings":[],"max":1,"min":0,"thresholds":{"mode":"absolute","steps":[{"color":"green"},{"color":"red","value":80}]},"unit":"percentunit"},"overrides":[]},"gridPos":{"h":5,"w":12,"x":0,"y":10},"id":33,"options":{"orientation":"auto","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"showThresholdLabels":false,"showThresholdMarkers":true},"pluginVersion":"9.3.2","targets":[{"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"editorMode":"code","expr":"(sum by (node,sr,nic)(net_request_sum_bw{node=\"$node\",sr=\"$sr\",wtype=\"BT\"} )+sum by (node,sr,nic)(net_request_sum_bw{node=\"$node\",sr=\"$sr\",wtype=\"GA\"} )) /sum by (node,sr,nic)( net_total_bw{node=\"$node\",sr=\"$sr\",wtype=\"GA\"})","hide":false,"legendFormat":"GA/BT:{{sr}}","range":true,"refId":"A"},{"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"editorMode":"code","expr":"scalar(net_be_pods_bw{node=\"$node\",nic=\"$nic\"} ) /sum by (node,sr,nic)( net_total_bw{node=\"$node\",sr=\"$sr\",wtype=\"BE\"})","hide":false,"legendFormat":"BE:{{sr}}","range":true,"refId":"B"}],"title":"Node-level Bandwidth Utilization","type":"gauge"},{"collapsed":true,"gridPos":{"h":1,"w":24,"x":0,"y":15},"id":44,"panels":[{"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"description":"","fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"left","barAlignment":0,"drawStyle":"line","fillOpacity":0,"gradientMode":"none","hideFrom":{"legend":false,"tooltip":false,"viz":false},"lineInterpolation":"stepBefore","lineStyle":{"fill":"solid"},"lineWidth":1,"pointSize":5,"scaleDistribution":{"type":"linear"},"showPoints":"auto","spanNulls":true,"stacking":{"group":"A","mode":"none"},"thresholdsStyle":{"mode":"off"}},"decimals":2,"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green"},{"color":"red","value":80}]},"unit":"MiBs"},"overrides":[]},"gridPos":{"h":9,"w":12,"x":0,"y":16},"id":45,"options":{"legend":{"calcs":[],"displayMode":"list","placement":"right","showLegend":true},"tooltip":{"mode":"single","sort":"none"}},"targets":[{"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"editorMode":"code","expr":"sum by (rwsum,node,disk) (disks_total_bw{node=\"$node\",disk=~\"/dev/$disk\",rwsum=\"$rwsum\",wtype=\"GA\"} )","hide":false,"interval":"1","legendFormat":"GA/BT Total:{{node}}:{{rwsum}}:{{disk}}","range":true,"refId":"A"},{"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"editorMode":"code","expr":"sum by (rwsum,node,disk) (disks_request_sum_bw{node=\"$node\",disk=~\"/dev/$disk\",rwsum=\"$rwsum\",wtype=\"GA\"})","hide":false,"interval":"1","legendFormat":"GA Total Req:{{node}}:{{rwsum}}:{{disk}}","range":true,"refId":"B"},{"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"editorMode":"code","expr":"sum by (rwsum,node,disk) (disks_request_sum_bw{node=\"$node\",disk=~\"/dev/$disk\",rwsum=\"$rwsum\",wtype=\"BT\"})","hide":false,"interval":"1","legendFormat":"BT Total Req:{{node}}:{{rwsum}}:{{disk}}","range":true,"refId":"C"},{"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"editorMode":"code","expr":"sum by (rwsum,node,disk) (disks_total_bw{node=\"$node\",disk=~\"/dev/$disk\",rwsum=\"$rwsum\",wtype=\"BE\"} )","hide":false,"interval":"1","legendFormat":"BE Total:{{node}}:{{rwsum}}:{{disk}}","range":true,"refId":"D"}],"title":"Node-level Bandwidth","type":"timeseries"},{"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"description":"","fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"left","barAlignment":0,"drawStyle":"line","fillOpacity":0,"gradientMode":"none","hideFrom":{"legend":false,"tooltip":false,"viz":false},"lineInterpolation":"smooth","lineStyle":{"fill":"solid"},"lineWidth":1,"pointSize":5,"scaleDistribution":{"type":"linear"},"showPoints":"auto","spanNulls":false,"stacking":{"group":"A","mode":"none"},"thresholdsStyle":{"mode":"off"}},"decimals":2,"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green"},{"color":"red","value":80}]},"unit":"MiBs"},"overrides":[{"__systemRef":"hideSeriesFrom","matcher":{"id":"byNames","options":{"mode":"exclude","names":["real:fio-bt-emptydir-1:BT:write:32k:/dev/nvme0n1"],"prefix":"All except:","readOnly":true}},"properties":[{"id":"custom.hideFrom","value":{"legend":false,"tooltip":false,"viz":true}}]}]},"gridPos":{"h":9,"w":12,"x":12,"y":16},"id":49,"options":{"legend":{"calcs":[],"displayMode":"list","placement":"right","showLegend":true},"tooltip":{"mode":"single","sort":"none"}},"targets":[{"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"editorMode":"code","expr":"sum by (pod,node,rw,wtype,disk)(pods_limit_bw{node=\"$node\",rw=\"$rwsum\",pod=\"$pod\",disk=~\"/dev/$disk\"} )","hide":false,"interval":"1","legendFormat":"lim:{{pod}}:{{wtype}}:{{rw}}:32k:{{disk}}","range":true,"refId":"A"},{"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"editorMode":"code","expr":"sum by (pod,node,rw,wtype,disk)(pods_request_bw{node=\"$node\",rw=\"$rwsum\",pod=\"$pod\",disk=~\"/dev/$disk\"} )","hide":false,"interval":"1","legendFormat":"req:{{pod}}:{{wtype}}:{{rw}}:32k:{{disk}}","range":true,"refId":"B"},{"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"editorMode":"code","expr":"sum by (pod,node,rw,wtype,disk)(pods_real_tran_bw{node=\"$node\",rw=\"$rwsum\",pod=\"$pod\",disk=~\"/dev/$disk\"} )","hide":false,"interval":"1","legendFormat":"real:{{pod}}:{{wtype}}:{{rw}}:32k:{{disk}}","range":true,"refId":"C"}],"title":"Pod-level Bandwidth","type":"timeseries"},{"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"fieldConfig":{"defaults":{"color":{"mode":"thresholds"},"mappings":[],"max":1,"min":0,"thresholds":{"mode":"absolute","steps":[{"color":"green"},{"color":"red","value":80}]},"unit":"percentunit"},"overrides":[]},"gridPos":{"h":4,"w":12,"x":0,"y":25},"id":47,"options":{"orientation":"auto","reduceOptions":{"calcs":["lastNotNull"],"fields":"","values":false},"showThresholdLabels":false,"showThresholdMarkers":true},"pluginVersion":"9.3.2","targets":[{"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"editorMode":"code","expr":"(sum by (rwsum,node,disk) (disks_request_sum_bw{node=\"$node\",disk=~\"/dev/$disk\",rwsum=\"$rwsum\",wtype=\"BT\"}) + sum by (rwsum,node,disk) (disks_request_sum_bw{node=\"$node\",disk=~\"/dev/$disk\",rwsum=\"$rwsum\",wtype=\"GA\"})) / sum by (node,rwsum,disk)( disks_total_bw{node=\"$node\",rwsum=\"$rwsum\",wtype=\"GA\",disk=~\"/dev/$disk\"})","hide":false,"legendFormat":"GA/BT:{{rwsum}}:{{disk}}","range":true,"refId":"A"},{"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"editorMode":"code","expr":"scalar(be_pods_bw{node=\"$node\",disk=\"/dev/$disk\",rwsum=\"$rwsum\"}) /sum by (node,rwsum,disk)( disks_total_bw{node=\"$node\",rwsum=\"$rwsum\",wtype=\"BE\",disk=~\"/dev/$disk\"})","hide":false,"legendFormat":"BE:{{rwsum}}:{{disk}}","range":true,"refId":"C"}],"title":"Node-level Bandwidth Utilization","type":"gauge"},{"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"description":"","fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"left","barAlignment":0,"drawStyle":"line","fillOpacity":0,"gradientMode":"none","hideFrom":{"legend":false,"tooltip":false,"viz":false},"lineInterpolation":"smooth","lineStyle":{"fill":"solid"},"lineWidth":1,"pointSize":5,"scaleDistribution":{"type":"linear"},"showPoints":"auto","spanNulls":false,"stacking":{"group":"A","mode":"none"},"thresholdsStyle":{"mode":"off"}},"decimals":2,"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green"},{"color":"red","value":80}]},"unit":"MiBs"},"overrides":[]},"gridPos":{"h":9,"w":12,"x":12,"y":25},"id":50,"options":{"legend":{"calcs":[],"displayMode":"list","placement":"right","showLegend":true},"tooltip":{"mode":"single","sort":"none"}},"targets":[{"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"editorMode":"code","expr":"sum by (pod,rw,wtype,node,bs,disk)(pods_real_untran_bw{node=\"$node\",pod=\"$pod\",disk=~\"/dev/$disk\"} )","hide":false,"interval":"1","legendFormat":"{{pod}}:{{wtype}}:{{rw}}:{{bs}}:{{disk}}","range":true,"refId":"A"}],"title":"Pod Real Bandwidth with Block Size","type":"timeseries"},{"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"fieldConfig":{"defaults":{"color":{"mode":"palette-classic"},"custom":{"axisCenteredZero":false,"axisColorMode":"text","axisLabel":"","axisPlacement":"left","barAlignment":0,"drawStyle":"line","fillOpacity":0,"gradientMode":"none","hideFrom":{"legend":false,"tooltip":false,"viz":false},"lineInterpolation":"smooth","lineWidth":1,"pointSize":5,"scaleDistribution":{"type":"linear"},"showPoints":"auto","spanNulls":false,"stacking":{"group":"A","mode":"none"},"thresholdsStyle":{"mode":"off"}},"mappings":[],"thresholds":{"mode":"absolute","steps":[{"color":"green"},{"color":"red","value":80}]},"unit":"binBps"},"overrides":[]},"gridPos":{"h":5,"w":12,"x":0,"y":29},"id":48,"options":{"legend":{"calcs":[],"displayMode":"list","placement":"right","showLegend":true},"tooltip":{"mode":"single","sort":"none"}},"targets":[{"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"editorMode":"code","exemplar":true,"expr":"irate(node_disk_read_bytes_total{node=\"$node\",device=~\"$disk\"}[2s])","interval":"1","legendFormat":"read:{{device}}","range":true,"refId":"A"},{"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"editorMode":"code","exemplar":true,"expr":"irate(node_disk_written_bytes_total{node=\"$node\",device=~\"$disk\"}[2s])","hide":false,"interval":"1","legendFormat":"write:{{device}}","range":true,"refId":"B"}],"title":"System-level Bandwidth","type":"timeseries"}],"title":"Scheduler View: Disk","type":"row"}],"refresh":"5s","schemaVersion":37,"style":"dark","tags":[],"templating":{"list":[{"current":{"selected":false,"text":"adq-ioi-2","value":"adq-ioi-2"},"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"definition":"node_disk_read_bytes_total","description":"choose a node","hide":0,"includeAll":false,"label":"Node","multi":false,"name":"node","options":[],"query":{"query":"node_disk_read_bytes_total","refId":"StandardVariableQuery"},"refresh":2,"regex":"/node=\"(?<text>[^\"]+)|node=\"(?<value>[^\"]+)/g","skipUrlSync":false,"sort":0,"type":"query"},{"current":{"selected":false,"text":"bt-ingress-2","value":"bt-ingress-2"},"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"definition":"container_cpu_load_average_10s{container_label_io_kubernetes_pod_namespace=\"default\"}","description":"choose a node","hide":0,"includeAll":false,"label":"Pod","multi":false,"name":"pod","options":[],"query":{"query":"container_cpu_load_average_10s{container_label_io_kubernetes_pod_namespace=\"default\"}","refId":"StandardVariableQuery"},"refresh":2,"regex":"/container_label_io_kubernetes_pod_name=\"(?<text>[^\"]+)|container_label_io_kubernetes_pod_name=\"(?<value>[^\"]+)/g","skipUrlSync":false,"sort":0,"type":"query"},{"current":{"selected":true,"text":["None"],"value":[""]},"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"definition":"disks_total_bw{node=\"$node\"}","description":"","hide":0,"includeAll":false,"label":"Disk","multi":true,"name":"disk","options":[],"query":{"query":"disks_total_bw{node=\"$node\"}","refId":"StandardVariableQuery"},"refresh":1,"regex":"/disk=\"/dev/(?<text>[^\"]+)|disk=\"/dev/(?<value>[^\"]+)/g","skipUrlSync":false,"sort":0,"type":"query"},{"current":{"selected":false,"text":"Write","value":"write"},"hide":0,"includeAll":false,"label":"Read/Write","multi":false,"name":"rwsum","options":[{"selected":false,"text":"Read","value":"read"},{"selected":true,"text":"Write","value":"write"},{"selected":false,"text":"Total","value":"total"}],"query":"Read : read, Write : write, Total : total","queryValue":"","skipUrlSync":false,"type":"custom"},{"current":{"selected":false,"text":"ens160","value":"ens160"},"datasource":{"type":"prometheus","uid":"P1809F7CD0C75ACF3"},"definition":"net_total_bw{node=\"$node\"}","description":"","hide":0,"includeAll":false,"label":"NIC","multi":false,"name":"nic","options":[],"query":{"query":"net_total_bw{node=\"$node\"}","refId":"StandardVariableQuery"},"refresh":1,"regex":"/nic=\"(?<text>[^\"]+)|nic=\"(?<value>[^\"]+)/g","skipUrlSync":false,"sort":0,"type":"query"},{"current":{"selected":false,"text":"Receive","value":"rcv"},"hide":0,"includeAll":false,"label":"Send/Receive","multi":false,"name":"sr","options":[{"selected":false,"text":"Send","value":"snd"},{"selected":true,"text":"Receive","value":"rcv"}],"query":"Send : snd , Receive : rcv","queryValue":"","skipUrlSync":false,"type":"custom"}]},"time":{"from":"now-15m","to":"now"},"timepicker":{},"timezone":"","title":"BOA-Monitor-Dashboard-DiskNet-240620","uid":"bjkwuQ8Sk","version":2,"weekStart":""}`}}
